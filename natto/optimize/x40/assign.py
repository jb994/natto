from lmz import Map,Zip,Filter,Grouper,Range,Transpose
import x40_dmp as dmp
from natto import input, process
from sklearn.metrics import adjusted_rand_score
import natto.out.draw as draw
import matplotlib
matplotlib.use('module://matplotlib-sixel')
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.metrics import confusion_matrix, ConfusionMatrixDisplay
import numpy as np
from scipy.optimize import linear_sum_assignment as lsa

'''
1. load the dict a => b,c OK
2. load the data           OK
3. joint pp (either b or b,c) OK

4. diffuse the real labels from b,, assign labels blabla

5. eval

'''



def getzedata(li,neighs=1,numcells=1500, seed = 31337):
    datasetnames = li[:neighs+1]
    zedata= [input.load100(x,
                          path = "/home/ubuntu/repos/natto/natto/data",
                          seed = seed,
                          subsample=numcells) for x in datasetnames]

    zedata =  process.Data().fit(zedata,
            visual_ftsel=False,
            pca = 20,
            make_readcounts_even=True,
            umaps=[2],
            sortfield = 0,# real labels need to follow the sorting i think...
            make_even=True)

    truelabels = [np.array(zedata.data[x].obs['true']) for x in [0,1]]
    return datasetnames, zedata, truelabels

def confuse(y1,y2, norm = True):
    #cm = confusion_matrix(y1,y2)
    cm = confusion_matrix(y1,y2)
    _, new_order = lsa(-cm)
    cm = cm[new_order]

    xlab,xcounts = np.unique(y2,return_counts = True)
    ylab,ycounts = np.unique(y1,return_counts=True)
    ylab,ycounts = ylab[new_order], ycounts[new_order]

    if norm:
        cm = cm.astype(float)
        for x in Range(xlab):
            for y in Range(ylab):
                res = (2*cm[y,x]) / (xcounts[x]+ycounts[y])
                #print(cm[y,x])
                #print(xcounts[x],ycounts[y])
                print(res)
                cm[y,x]  = res
    print(cm)
    sns.heatmap(cm,xticklabels=xlab,yticklabels=ylab, annot=False,
            linewidths=.5,cmap="YlGnBu" , square=True)
    plt.xlabel('Clusters data set 2')
    plt.ylabel('Clusters data set 1')

def confuse2(y1,y2):
    f=plt.figure(figsize=(16,8))
    ax=plt.subplot(121,title ='absolute hits')
    confuse(y1,y2,norm=False)
    ax=plt.subplot(122,title ='relative hits (2x hits / sumOfLabels)')
    confuse(y1,y2,norm=True)
    plt.show()


neighbors = dmp.neighs(draw=False)
plt.show()

for i in [10]:


    # names, zedata, truelabels = getzedata(neighbors[i], neighs = 1, numcells = 1000)
    # draw.cmp2(*truelabels,*zedata.d2)
    # print(f"annotation score: {adjusted_rand_score(*truelabels)}")
    # print(f"{names=}")


    y1,y2 = [np.array([-1,  2,  6,  1, -1, -1, -1, -1, -1, -1,  3,  2,  2, -1, -1,  4,  4, -1, -1, -1,  5, -1, -1, -1, -1,  0,  2,  2, -1, -1, -1, -1, -1, -1, -1, -1, -1,  2, -1,  6, -1, -1,  1, -1,  0, -1,  1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  5, -1,  0,  4,  9, -1, -1, -1, -1, 2,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  5, -1, -1, -1, 8, -1, -1, -1, -1, -1,  5, -1,  5,  0, -1, -1, -1, -1, -1, -1, -1, -1,  2,  0, -1,  0,  4, -1, -1, -1,  2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  0, -1, -1, -1,  1, -1,  0,  6, -1, -1,  7, -1, -1,  7, -1,  7, -1, -1, -1, -1,  1,  1, -1, -1, -1, -1,  2, -1,  1, -1, -1, -1, -1, -1,  4,  7, -1, -1, -1,  8, -1,  1,  0,  4, -1,  0, -1, -1, -1,  4, -1, -1,  6, -1, -1, -1, -1, -1, -1, -1,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  5, -1, -1,  7, -1, -1, -1, 0, -1,  7, -1,  0, -1, -1, -1,  5, -1, -1, -1, -1, -1, -1, -1,  2, 6, -1, -1, -1, -1, -1, -1,  1, -1,  6, -1, -1, -1, -1, -1,  4,  1, -1,  4, -1, -1, -1,  2, -1, -1, -1, -1, -1, -1, -1,  3,  1,  1, -1, -1, -1, -1,  2, -1,  3, -1, -1,  3, -1,  0, -1, -1, -1, -1, -1, -1, 3, -1, -1, -1, -1, -1, -1, -1, -1, -1,  0, -1,  9, -1, -1, -1, 10, -1, -1, -1,  5, -1, -1,  4,  2, -1, -1, -1, -1, -1, -1,  1,  1, -1, 3, -1, -1, -1, -1,  2, -1, -1,  3, -1,  2, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  5, -1, -1,  2,  2, -1,  1, -1, -1, -1, -1,  0, -1, -1, -1, -1,  0, -1, -1, -1, -1, -1, 10,  6, -1, -1, -1, -1, -1,  0, -1, -1, -1,  1, -1,  2,  1, -1,  7, -1, -1, -1, -1, -1, 0, -1, -1, -1, -1, -1, -1, -1, -1,  1, -1,  1, -1, -1, -1, -1, -1, -1, -1, -1,  7,  7, -1, -1,  2, -1, -1, -1, -1, -1,  6, -1, -1,  8, 10, -1, -1, -1, -1,  5, -1, -1, -1, -1, -1, -1, -1, -1,  6,  1, -1, 8,  2, -1,  0,  4, -1,  0, -1, -1, -1, -1, -1,  2,  2, -1, -1,  1, -1, -1, -1, -1, -1, -1,  1,  2, -1,  1, -1,  9, -1,  8,  4,  4, -1, -1,  1, -1, -1, -1, -1, -1,  0, -1, -1, -1, -1,  4, -1, -1, -1, -1, -1,  4, -1,  4, -1, -1,  8, -1,  2,  0,  0, -1, -1, -1, -1,  0, -1, 0, -1, -1, -1,  0, -1,  0,  4,  1, -1,  2, -1, -1,  3,  2, -1,  0, 9, -1,  1, -1, -1, -1, -1, -1,  0, -1, -1, -1,  5, -1,  0, -1,  1, -1, -1, -1, -1,  2, -1, -1, -1,  6, -1, -1,  1, -1, -1, -1,  5, -1, -1,  1, -1,  7,  3, -1, -1, -1, -1, -1,  3, -1,  1, -1, -1, -1, -1, -1, -1,  1, -1, -1, -1, -1,  1, -1, -1,  7, -1,  1, -1, -1, -1,  1, 1, -1, -1,  0,  3, -1,  1, -1, -1, -1,  0,  4,  3, -1,  6,  1, -1, 8,  6,  2,  9, -1,  5,  3, -1,  5, -1, -1, -1,  1,  1, -1,  8, -1, -1, -1, -1, -1, -1,  2, -1,  4, -1, -1, -1, -1,  2, -1, -1,  5, -1, 1,  1, -1, -1,  2, -1, -1, -1, -1,  8, -1, -1, -1,  9,  0,  4,  7, -1, -1, -1, -1,  8, -1,  0,  5,  1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  5,  4,  0, -1, -1,  2, 0,  0, -1,  8, -1, -1, -1, -1, -1,  0,  9, -1, -1, -1,  2,  6,  7, -1,  5, -1,  0]), np.array([-1,  1,  5,  3, -1, -1, -1, -1, -1, -1, -1,  1,  7, -1, -1,  0,  0, -1,  1,  9, -1, -1, -1,  4, -1,  0, -1, -1, -1, -1, -1,  4, -1, -1, 8, -1,  0,  1, -1, -1, -1, -1,  2, -1,  0, -1,  2, -1, -1, -1, -1, -1,  0, -1, -1, -1, -1, -1, -1, -1,  0,  3,  0,  0, -1, -1, -1, -1, 1,  8, -1, -1, -1,  4,  6, -1, -1, -1, -1, -1, -1,  6,  3, -1, -1, 2,  1, -1, -1, -1, -1, -1, -1,  9,  0,  0,  8, -1,  8, -1, -1, -1, -1, -1,  3, -1,  3,  0,  0, -1, -1,  1,  6, -1, -1, -1, -1, -1, -1, 1, -1, -1,  0, -1, -1, -1, -1, -1,  0,  1, -1, -1,  1, -1,  2,  3, -1,  1, -1,  5, -1, -1,  3,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1, -1, -1,  4,  7, -1, -1, -1,  2, -1, -1,  4,  3, -1,  0, -1, -1, -1,  4, -1, -1, -1,  1, -1, -1, -1, -1,  0, -1,  3, -1, -1,  0,  3, -1, -1, -1, -1,  4, -1,  9, -1, -1, -1, -1, -1, -1,  4, -1, -1, -1, 3, -1,  7, -1,  4, -1,  0, -1,  9, -1,  2, -1,  2,  3, -1, -1,  1, 7, -1, -1, -1, -1, -1, -1,  2, -1,  7,  2, -1, -1, -1, -1,  3,  3, -1,  3, -1, -1,  0, -1, -1,  4, -1, -1, -1, -1, -1, -1,  1, -1, -1, 0, -1, -1,  1, -1, -1,  0, -1, -1,  5,  0,  2, -1,  3, -1, -1, -1, 8, -1, -1, -1, -1,  4, -1, -1, -1, -1,  3, -1,  0, -1, -1, -1,  7, -1, -1, -1,  6, -1, -1,  0, -1, -1, -1,  6, -1, -1, -1,  0,  3, -1, 0, -1, -1, -1,  6, -1, -1, -1, -1, -1,  1, -1, -1, -1,  1, -1, -1, 8, -1, -1, -1, -1, -1,  1, -1, -1, -1,  1,  1,  0,  2, -1, -1, -1, 4,  3, -1, -1, -1, -1,  0,  1, -1, -1, -1, -1, -1,  5, -1, -1, -1, -1,  4, -1, -1, -1, -1, -1, -1,  1, -1, -1,  7, -1,  6, -1, -1, -1, -1, -1, -1,  5,  1, -1, -1, -1, -1,  2, -1,  5,  4, -1,  1, -1, -1, -1, -1, -1,  5,  4, -1, -1,  1, -1, -1, -1, -1,  2,  5,  1, -1,  2, 7, -1, -1, -1, -1,  6, -1,  5, -1, -1, -1,  1, -1, -1,  0,  3, -1, -1, -1, -1,  3,  0,  2,  0, -1, -1, -1,  0, -1,  1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  1, -1,  2, -1, -1,  6,  2,  0,  4, -1, -1,  2,  1, -1, -1, -1,  7,  4, -1, -1, -1, -1,  3, -1,  4, -1, -1, 5,  4,  1,  4,  1, -1, -1, -1,  1,  0,  0, -1, -1, -1, -1,  0, -1, -1, -1, -1,  0, -1,  0,  0,  0,  2, -1, -1, -1,  5,  8,  1,  2,  4, 0, -1,  2, -1, -1, -1, -1,  0,  0, -1, -1,  0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  0, -1,  4,  1, -1,  2,  7, -1, -1, -1, -1, 0,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8, -1, -1, -1,  2, -1, -1, -1,  2, -1, -1, -1,  8, -1, -1, -1, -1, -1,  5, 2,  0, -1, -1,  8, -1, -1,  2, -1, -1,  0, -1,  0, -1,  5, -1, -1, 2,  0, -1,  3, -1, -1,  8, -1, -1,  0,  2, -1,  2,  2, -1,  3, -1, 5, -1, -1, -1, -1, -1, -1,  3, -1,  4,  4, -1,  1, -1, -1, -1, -1, 3,  2, -1, -1,  5, -1,  2, -1, -1,  2, -1, -1, -1,  3, -1,  0,  3, -1, -1, -1, -1,  2,  6, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  0, -1,  8, -1, -1,  6, -1, -1, -1, -1, -1, -1, -1,  4, -1, -1, -1, -1, 0,  0, -1,  2,  4, -1,  2, -1, -1, -1,  3, -1, -1, -1,  3,  5,  7, -1,  9, -1, -1])]
    mask = np.logical_and(y1!=-1, y2!=-1)
    y1,y2 = y1[mask], y2[mask]
    confuse2(y1,y2)
    plt.tight_layout()
    plt.show()

    # then we diffuse
    # then we do it again and compare the rand scores








